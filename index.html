<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="UTF-8"/>
    <title>Shamir's Keystore</title>
    <script>(function(l){var i,s={touchend:function(){}};for(i in s)l.addEventListener(i,s);})(document);</script>
    <style>
      @import url('https://fonts.googleapis.com/css?family=Crimson+Text|Fira+Code|Montserrat&amp;display=swap');
      div.main {
        width: 80%; border-style: outset; border-width: 1px; border-radius: 3px; border-color: rgb(224,224,224); margin-left: auto; margin-right: auto;
        padding-left: 1em; padding-right: 1em; padding-top: 0.25em; padding-bottom: 0.25em; background-color: rgb(224,224,224)
      }
      p.headline-0 {
        background-color: rgb(178,24,43); color: rgb(253,219,199); font-family: 'Montserrat', sans-serif; padding: 3px; border-radius: 3px; font-size: 1.5em; 
        padding-left: 1rem; padding-right: 0.75rem; font-weight: bold;
      }
      p.headline-1 {
        background-color: rgb(77,77,77); color: rgb(253,219,199); font-family: 'Montserrat', sans-serif; padding: 3px; border-radius: 3px; font-size: 1em; 
        padding-left: 1rem; font-weight: bold;
      }
      p.section {
        color: rgb(26,26,26); font-family: 'Crimson Text', serif; text-align: justify
      }
      div.code {
        border-style: dashed; border-width: 1px; border-color: rgb(103,0,31); background-color: rgb(253,219,199); width: 80%; margin-left: auto; 
        margin-right: auto; overflow-x: auto; white-space: nowrap
      }
      p.code {
        font-family: 'Fira Code', monospace; font-size: 12px; text-align: left; padding-left: 1rem
      }
      p.formula {
        font-style: italic; font-family: 'Fira Code', monospace; text-align: center; overflow-x: auto; white-space: nowrap; overflow-y: hidden
      }
      span.formula {
        font-style: italic; font-family: 'Fira Code', monospace;
      }
      div.drop-down-button {
        height: 0rem; padding-right: 1rem; position: relative; float: right;
      }
      img.menu {
        height: 1.5rem; margin-top: 0.8rem;
      }
      div.drop-down-content {
        display: none; background-color: rgb(253,219,199); padding: 1rem; position: absolute; top: 0; left: -5rem; width: 10rem;
        border-radius: 0.25rem; border-color: rgb(77,77,77); border-style: solid; border-width: 1px
      }
      div.drop-down-button:hover div.drop-down-content {
        display: inline-block;
      }
      a.menu {
        color: rgb(77,77,77); font-size: 0.9rem; line-height: 100%; font-family: 'Montserrat', sans-serif;
      }
      th.cell {
        border-bottom-style: none; border-width: 1px; width: 25%; border-top-style: none; background-color: rgb(244,165,130)
      }
      td.cell {
        border-bottom-style: none; border-width: 1px; width: 25%; border-top-style: none; background-color: rgb(146,197,222)
      }
      div.console {
        border-style: dashed; border-width: 1px; border-color: rgb(103,0,31); background-color: rgb(209,229,240); width: 60%; margin-left: auto; 
        margin-right: auto; overflow-x: auto; white-space: nowrap
      }
      p.console {
        font-family: 'Fira Code', monospace; font-size: 12px; text-align: left; padding-left: 1rem
      }
      span.code {
        border-style: solid; border-width: 1px; border-color: rgb(103,0,31); background-color: rgb(253,219,199); border-radius: 3px;
        font-family: 'Fira Code', monospace; font-size: 11px;
      }
    </style>
  </head>
  <body style="background-color: rgb(255,255,255)">
    <div class="main">
      <p style="color: rgb(26,26,26); font-family: 'Crimson Text', serif; font-style: italic; text-align: right; border-bottom-style: solid; border-bottom-width: 1px; 
         border-bottom-color: rgb(26,26,26)">Last updated: 2020-09-08</p>
      <div class="drop-down-button">
        <img class="menu" src="menu-widget.png" alt="menu"/>
        <div class="drop-down-content">
          <a class="menu" href="#2">Abstract</a><br/>
          <a class="menu" href="#3">1. Build</a><br/>
          <a class="menu" href="#4">2. Source Control</a><br/>
          <a class="menu" href="#5">3. The Algorithm</a><br/>
          <a class="menu" href="#6">4. UML Diagrams</a><br/>
          <a class="menu" style="font-size: 0.7rem; padding-left: 0.5rem" href="#10">4.1 Component Diagrams</a><br/>
          <a class="menu" style="font-size: 0.7rem; padding-left: 0.5rem" href="#11">4.2 Class Diagram</a><br/>
          <a class="menu" href="#7">5. Reports</a><br/>
          <a class="menu" href="#8">6. Download</a><br/>
          <a class="menu" href="#9">7. Usage</a><br/>
          <a class="menu" href="#imprint">Imprint</a>
        </div>
      </div>
      <p id="1" class="headline-0">Shamir's Keystore</p>
      <p id="2" class="headline-1">Abstract</p>
      <p class="section">
        This <a href="https://docs.oracle.com/en/java/javase/11/security/java-cryptography-architecture-jca-reference-guide.html">JCA provider</a> presently implements 
        <a href="https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing">Shamir's Secret Sharing</a> using
        Newton Polynomials. Building on this, a <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/security/KeyStore.html">KeyStore</a> Engine
        as defined by the <a href="https://docs.oracle.com/en/java/javase/11/security/howtoimplaprovider.html">Java Cryptographic Architecture</a> is provided. Such a keystore instance might 
        be unlocked - apart from the master password - by a previously computed subset of secret shares. In order to be able to reconstruct the master password a certain number of secret shares 
        above a given threshold must be combined. Shamirs scheme is information-theoretically secure. This means that an attacker does not get any additional information about the original master 
        password with fewer shares as defined by the given threshold. In this way, it is possible to enforce e.g. the four-eye-principle. The provided keystore implementation
        is PKCS12 compliant and internally relies on the implementation provided by the Java platform.
      </p>
      <p class="section">
        <a href="#1">[ToC]</a>
      </p>
      <p id="3" class="headline-1">1. Build</p>
      <p class="section">
          On Windows I recommend to use the <a href="https://git-scm.com/download/win">Git Bash</a>. Then you would have to disable the automatic conversion of Unix style end-of-line marker, 
          otherwise one of the test cases might fail. But please also note the instructions when executing the <a href="#9">demo app</a> within the Git Bash.
      </p>
      <div class="code">
        <p class="code">
          $ git config --global core.autocrlf false
        </p>
      </div>
      <p class="section">
        Now clone the project:
      </p>
      <div class="code">
        <p class="code">
          $ git clone https://github.com/chr78rm/shamirs-keystore.git<br/>
          $ cd shamirs-keystore
        </p>
      </div>
      <p class="section">
        <a href="https://maven.apache.org/">Maven</a> and a JDK11+ is required for the build of the multi-module project:
      </p>
      <div class="code">
        <p class="code">
          $ mvn clean install
        </p>
      </div>
      <p class="section">
        Above command will compile the sources, run the tests and install the provider into the local Maven repo.
      </p>
      <p class="section">
        Note that the included demo app makes use of the pkix sub-module from the <a href="https://www.bouncycastle.org/java.html">Bouncy Castle</a> crypto library for 
        programmatically generating self-signed X.509 certificates which is something that cannot be easily done with the JDK alone. Aside from this two other
        dependencies must be mentioned: JSON processing by <a href="https://resteasy.github.io/">RESTEasy</a> and of course the 
        <a href="https://www.scala-lang.org/">Scala</a>-Library since the core module containing the actual algorithm is written in Scala.
      </p>
      <p class="section">
        <a href="#1">[ToC]</a>
      </p>
      <p id="4" class="headline-1">2. Source Control</p>
      <p class="section">
        The source code is hosted in GitHub: <a href="https://github.com/chr78rm/shamirs-keystore">https://github.com/chr78rm/shamirs-keystore</a>.
        <a href="https://www.gnu.org/licenses/gpl-3.0.en.html" style="float: right">
          <img style="height: 1.5rem" src="https://www.gnu.org/graphics/gplv3-with-text-84x42.png" alt="gplv3"/>
        </a>
      </p>
      <p class="section">
        <a href="#1">[ToC]</a>
      </p>
      <p id="5" class="headline-1">3. The Algorithm</p>
      <p class="section">
        Consider the polynomial
      </p>
      <p class="formula">
        P<sub>k-1</sub>(x) = a<sub>k-1</sub>x<sup>k-1</sup> + ... + a<sub>2</sub>x<sup>2</sup> + a<sub>1</sub>x + a<sub>0</sub>
      </p>
      <p class="section">
        of degree <span class="formula">k-1</span> given in the canonical form. Recall that you need <span class="formula">k</span> supporting points to recover a polynomial of
        degree <span class="formula">k-1</span>. Shamir's <span class="formula">(k,n)</span> threshold scheme is building upon this property. A trusted 
        authority randomly selects a polynomial <span class="formula">P<sub>k-1</sub></span> and computes <span class="formula">n</span> supporting points whereby 
        <span class="formula">n >= k</span> applies. 
        The to be shared secret <span class="formula">s</span> is encoded as <span class="formula">a<sub>0</sub></span>. The <span class="formula">n</span> supporting points 
        are distributed among the participants. To compute the original secret <span class="formula">s</span> the participants must combine <span class="formula">k</span> of 
        the supporting points. In order to avoid that an adversary gains any knowledge about the secret by merging less than <span class="formula">k</span> supporting points 
        all computations will by implemented by using finite field arithmetic. That means we choose a finite field <span class="formula">&#120125;<sub>p</sub></span> whereby 
        <span class="formula">p</span> is prime and <span class="formula">a<sub>0</sub> &lt; p</span> applies.
      </p> 
      <p class="section">
        The simplest procedure for reconstructing a polynomial <span class="formula">P</span> of degree <span class="formula">k-1</span> with given <span class="formula">k</span> 
        supporting points <span class="formula">(x<sub>0</sub>,y<sub>0</sub>),...,(x<sub>k-1</sub>,y<sub>k-1</sub>)</span> is by devising a system of 
        <span class="formula">k</span> linear equations. A parabola, for instance, is defined by three supporting points 
        <span class="formula">(x<sub>0</sub>,y<sub>0</sub>),(x<sub>1</sub>,y<sub>1</sub>),(x<sub>2</sub>,y<sub>2</sub>)</span>. The coefficients
        <span class="formula">a<sub>0</sub>,a<sub>1</sub>,a<sub>2</sub></span> can be computed by solving the system of linear equations below:
      </p>
      <p class="formula">
        y<sub>0</sub> = a<sub>2</sub>x<sub>0</sub><sup>2</sup> + a<sub>1</sub>x<sub>0</sub> + a<sub>0</sub><br/>
        y<sub>1</sub> = a<sub>2</sub>x<sub>1</sub><sup>2</sup> + a<sub>1</sub>x<sub>1</sub> + a<sub>0</sub><br/>
        y<sub>2</sub> = a<sub>2</sub>x<sub>2</sub><sup>2</sup> + a<sub>1</sub>x<sub>2</sub> + a<sub>0</sub><br/>
      </p>
      <p class="section">
        There are, however, more efficient algorithms. This distribution uses the Newton interpolation method to recover the secret <span class="formula">s</span>.
        A Newton polynomial of degree <span class="formula">k-1</span> is given by
      </p>
      <p class="formula">
        P<sub>k-1</sub>(x) = <span style="font-size: 18px; font-style: normal">&#x1D768;</span>
        <sub style="font-size: 10px; position: relative; top: 0.25em; left: -0.75em">i=0</sub>
        <sup style="position: relative; left: -3.5em; top: -0.25em; font-size: 10px">k-1</sup>
        <span style="position: relative; left: -2.25em;">c<sub>i</sub>N<sub>i</sub>(x)</span>
      </p>
      <p class="section">
        with Newton coefficients <span class="formula">c<sub>0</sub>,c<sub>1</sub>,...,c<sub>k-1</sub></span> and the Newton basis polynomials
        <span class="formula">N<sub>0</sub> = 1</span> and 
        <span class="formula">
          N<sub>i</sub> = <span style="font-size: 18px; font-style: normal">&#x1D79F;</span>
          <sub style="font-size: 10px; position: relative; top: 0.25em; left: -1em">j=0</sub>
          <sup style="position: relative; left: -3.75em; top: -0.25em; font-size: 10px">i-1</sup>
          <span style="position: relative; left: -2.5em;">(x - x<sub>j</sub>).</span>
        </span>
      </p>
      <p class="section">
        This gives
      </p>
      <p class="formula">
        P<sub>k-1</sub>(x) = c<sub>0</sub> + c<sub>1</sub>(x - x<sub>0</sub>) + c<sub>2</sub>(x - x<sub>0</sub>)(x - x<sub>1</sub>) + &#x22EF; + c<sub>k-1</sub>(x - x<sub>0</sub>) &#x22EF; (x - x<sub>k-2</sub>)
      </p>
      <p class="section">
        By applying <span class="formula">x &#x2190; x<sub>0</sub>,x &#x2190; x<sub>1</sub>,x &#x2190; x<sub>2</sub>,...</span> it follows
      </p>
      <p class="formula" style="text-align: left; padding-left: 10em">
        P(x<sub>0</sub>) = c<sub>0</sub><br/>
        P(x<sub>1</sub>) = c<sub>0</sub> + c<sub>1</sub>(x<sub>1</sub> - x<sub>0</sub>)<br/>
        P(x<sub>2</sub>) = c<sub>0</sub> + c<sub>1</sub>(x<sub>2</sub> - x<sub>0</sub>) + c<sub>2</sub>(x<sub>2</sub> - x<sub>0</sub>)(x<sub>2</sub> - x<sub>1</sub>)<br/>
        P(x<sub>3</sub>) = c<sub>0</sub> + c<sub>1</sub>(x<sub>3</sub> - x<sub>0</sub>) + c<sub>2</sub>(x<sub>3</sub> - x<sub>0</sub>)(x<sub>3</sub> - x<sub>1</sub>) + c<sub>3</sub>(x<sub>3</sub> - x<sub>0</sub>)(x<sub>3</sub> - x<sub>1</sub>)(x<sub>3</sub> - x<sub>2</sub>)<br/>
        <span style="font-style: normal; position: relative; left: 2em">&#x22EE;</span><span style="font-style: normal; position: relative; left: 5em">&#x22EE;</span>
      </p>
      <p class="section">
        Since we are interested in recovering the Newton polynomial by using the supporting points we rearrange the equations above:
      </p>
      <p class="formula" style="text-align: left; padding-left: 10em">
        c<sub>0</sub> = y<sub>0</sub><br/>
        c<sub>1</sub> = (y<sub>1</sub> - c<sub>0</sub>)/(x<sub>1</sub> - x<sub>0</sub>)<br/>
        c<sub>2</sub> = (y<sub>2</sub> - c<sub>0</sub> - c<sub>1</sub>(x<sub>2</sub> - x<sub>0</sub>))/(x<sub>2</sub> - x<sub>0</sub>)(x<sub>2</sub> - x<sub>1</sub>)<br/>
        c<sub>3</sub> = (y<sub>3</sub> - c<sub>0</sub> - c<sub>1</sub>(x<sub>3</sub> - x<sub>0</sub>) - c<sub>2</sub>(x<sub>3</sub> - x<sub>0</sub>)(x<sub>3</sub> - x<sub>1</sub>))/(x<sub>3</sub> - x<sub>0</sub>)(x<sub>3</sub> - x<sub>1</sub>)(x<sub>3</sub> - x<sub>2</sub>)<br/>
        <span style="font-style: normal; position: relative; left: 1em">&#x22EE;</span><span style="font-style: normal; position: relative; left: 3em">&#x22EE;</span>
      </p>
      <p class="section">
        Now we can clearly see a recurring pattern. Thus, the Newton coefficients can be computed by a recursive procedure and by memoizing the already calculated 
        coefficients (dynamic programming), 
        see <a href="https://github.com/chr78rm/shamirs-keystore/blob/master/shamirs-secret-sharing/src/main/scala/de/christofreichardt/scala/shamir/NewtonInterpolation.scala">NewtonInterpolation.scala</a>
        for details.
      </p>
      <p class="section">
        We need to evaluate the interpolated polynom at least at one point, namely at <span class="formula">P(0) = a<sub>0</sub></span> to recover the original secret. An efficient
        way of doing this is by applying Horner's scheme. The Newton polynomial <span class="formula">P</span> of degree <span class="formula">k-1</span> can be rewritten as
      </p>
      <p class="formula">
        P<sub>k-1</sub>(x) = c<sub>0</sub> + (x - x<sub>0</sub>)[c<sub>1</sub> + (x - x<sub>1</sub>)[c<sub>2</sub> + &#x22EF; + c<sub>k-1</sub>(x - x<sub>k-2</sub>)] &#x22EF; ]
      </p>
      <p class="section">
        so that <span class="formula">P(x)</span> can be calculated recursively:
      </p>
      <p class="formula" style="text-align: left; padding-left: 10em">
        b<sub>0</sub> = c<sub>0</sub> + (x - x<sub>0</sub>)b<sub>1</sub><br/>
        b<sub>1</sub> = c<sub>1</sub> + (x - x<sub>1</sub>)b<sub>2</sub><br/>
        b<sub>2</sub> = c<sub>2</sub> + (x - x<sub>2</sub>)b<sub>3</sub><br/>
        <span style="font-style: normal; position: relative; left: 1em">&#x22EE;</span><span style="font-style: normal; position: relative; left: 3em">&#x22EE;</span><br/>
        b<sub>k-1</sub> = c<sub>k-1</sub>
      </p>
      <p class="section">
        where <span class="formula">P(x) = b<sub>0</sub></span> .
      </p>
      <p class="section">
        <a href="#1">[ToC]</a>
      </p>
      <p id="6" class="headline-1">4. UML Diagrams</p>
      <p id="10" class="section" style="font-family: 'Montserrat', sans-serif; padding-left: 2rem">4.1 Component Diagrams</p>
      <div style="text-align: center">
        <img style="width: 80%; height: auto" src="uml/component-diagram-1.png" alt="component-diagram-1"/>
        <img style="width: 80%; height: auto; margin-top: 1em" src="uml/component-diagram-2.png" alt="component-diagram-2"/>
      </div>
      <p id="11" class="section" style="font-family: 'Montserrat', sans-serif; padding-left: 2rem">4.2 Class Diagram</p>
      <div style="text-align: center">
        <img style="width: 80%" src="uml/class-diagram.png" alt="class-diagram"/>
      </div>
      <p class="section">
        <a href="#1">[ToC]</a>
      </p>
      <p id="7" class="headline-1">5. Reports</p>
      <p class="section">
        The two sub modules shamirs-keystore - containing the actual JCA provider - and shamirs-demo are both using <a href="https://junit.org/junit5/">JUnit5</a> for their 
        unit testing. The currently recommended Maven <a href="https://maven.apache.org/surefire/maven-surefire-plugin/">surefire</a> plugin 
        version 3.0.0-M4 doesn't accurately produce the test reports at least not when using 
        <a href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-nested">nested tests</a>. The two linked reports below have been generated by a custom 
        JUnit5 <a href="https://junit.org/junit5/docs/current/user-guide/#launcher-api-listeners-custom">TestExecutionListener</a> during the last build.
      </p>
      <table style="font-family: 'Crimson Text', serif; width: 40%; margin-left: auto; margin-right: auto">
        <tbody style="text-align: center">
          <tr>
            <th class="cell" style="width: 50%">Artifact</th>
            <th class="cell" style="width: 50%">Report</th>
          </tr>
          <tr style="">
            <td style="border-bottom-style: none; border-width: 1px; width: 50%; border-top-style: none; background-color: rgb(146,197,222)">shamirs-keystore</td>
            <td style="border-bottom-style: none; border-width: 1px; width: 50%; border-top-style: none; background-color: rgb(146,197,222)"><a href="./reports/shamirs-keystore-summary.txt">summary.txt</a></td>
          </tr>
          <tr>
            <td style="border-bottom-style: none; border-bottom-width: 1px; width: 50%; background-color: rgb(146,197,222)">shamirs-demo</td>
            <td style="border-bottom-style: none; border-bottom-width: 1px; width: 50%; background-color: rgb(146,197,222)"><a href="./reports/shamirs-demo-summary.txt">summary.txt</a></td>
          </tr>
        </tbody>
      </table>
      <p class="section">
        The sub module shamirs-secret-sharing - containing the actual algorithm - is written in <a href="https://www.scala-lang.org/">Scala</a> and uses 
        <a href="http://www.scalatest.org/">ScalaTest</a> for its unit testing. Again a custom 
        <a href="http://doc.scalatest.org/3.1.1/org/scalatest/Reporter.html">Reporter</a>
        is used to collect the events occurring throughout the execution of the tests. The linked report below has been generated during the last build.
      </p>
      <table style="font-family: 'Crimson Text', serif; width: 40%; margin-left: auto; margin-right: auto">
        <tbody style="text-align: center">
          <tr>
            <th class="cell" style="width: 50%">Artifact</th>
            <th class="cell" style="width: 50%">Report</th>
          </tr>
          <tr style="">
            <td style="border-bottom-style: none; border-width: 1px; width: 50%; border-top-style: none; background-color: rgb(146,197,222)">shamirs-secret-sharing</td>
            <td style="border-bottom-style: none; border-width: 1px; width: 50%; border-top-style: none; background-color: rgb(146,197,222)"><a href="./reports/shamirs-secret-sharing-summary.txt">summary.txt</a></td>
          </tr>
        </tbody>
      </table>
      <p class="section">
        <a href="#1">[ToC]</a>
      </p>
      <p id="8" class="headline-1">6. Download</p>
      <p class="section">
        By the time I initially experimented with this Maven multi module project I had run into difficulties regarding the automatic execution of unit tests
        when applying the principles of the new Java module system (Jigsaw). I decided to waste no further time in finding workable solutions and leave this for
        future versions. That is to say the module boundaries you see in the <a href="#6">UML Diagrams</a> section are respected by the different components 
        but are not presently enforced. The demo application can optionally be packaged as uber-jar by the Apache Maven Shade plugin using a certain build profile.
        Consequently the Maven Shade plugin is currently configured to strip off all module-info.class files from external libraries - shading would break the
        encapsulation anyway.
        The subsequent provided download contains the demo app and both the core module with the algorithm and the actual JCA provider.
      </p>
      <table style="font-family: 'Crimson Text', serif; width: 80%; margin-left: auto; margin-right: auto">
        <tbody style="text-align: center">
          <tr>
            <th class="cell" style="width: 15%">Artifact</th>
            <th class="cell">Archive</th>
            <th class="cell">Timestamp</th>
            <th class="cell">sha512 checksum</th>
          </tr>
          <tr style="">
            <td class="cell" style="width: 15%">shamirs-demo</td>
            <td class="cell">
              <a href="https://www.dropbox.com/s/rhs76o31qppix9m/shamirs-demo-1.0.0-beta.zip?dl=1">shamirs-demo-1.0.0-beta.zip</a>
            </td>
            <td class="cell">2020-05-20 13:50:27.364 +0200</td>
            <td class="cell">
              <a href="./shamirs-demo-1.0.0-beta.zip.sha512.txt">shamirs-demo-1.0.0-beta.zip.sha512</a>
            </td>
          </tr>
        </tbody>
      </table>
      <p class="section">
        Note that the demo app includes binaries from external open source projects, namely the <a href="https://www.scala-lang.org/">Scala</a>-Library, 
        the JSON-Processing provider from <a href="https://resteasy.github.io/">RESTEasy</a> and
        the pkix sub-module from <a href="https://www.bouncycastle.org/java.html">Bouncy Castle</a>.
      </p>
      <p class="section">
        <a href="#1">[ToC]</a>
      </p>
      <p id="9" class="headline-1">7. Usage</p>
      <p class="section">
          <a href="#8">Download</a> the demo app and unzip the archive into a directory of your choice. A JDK11+ is needed for the execution of the app. You have to translate the subsequent bash 
        commands into their <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cmd">cmd</a> equivalents if you are working on Windows and aren't using 
        the <a href="https://git-scm.com/download/win">Git Bash</a>. I discourage the usage of the Windows PowerShell. Following commands show the relevant content of the distribution:
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">$ cd shamirs-demo/
$ ls
LICENCE.txt  log  NOTICE.txt  run-shamirs-demo.sh  src  target  workspace
$ ls target/
shamirs-demo-1.0.0-beta.jar
$ ls --recursive workspace/
workspace/:
my-workspace-0

workspace/my-workspace-0:
my-keys.p12  test-0.json  test-1.json  test-2.json  test-3.json  test-4.json  test-5.json  test-6.json  test.json</p>
      </div>
      <p class="section">
        On Linux the demo can be started with <span class="code">./run-shamirs-demo.sh</span>. On Windows and using the Git Bash you will instead need <span class="code">winpty sh -i -c ./run-shamirs-demo.sh</span>
        or simply <span class="code">winpty java -jar target/shamirs-demo-1.0.0-beta.jar</span>. Without the wrapper <a href="https://github.com/rprichard/winpty">winpty</a> provided by the Git Bash distribution there would be no 
        <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/io/Console.html">Console</a> and 
        <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/System.html#console()">System.console()</a> would return null. Using the command interpreter
        <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cmd">cmd</a> of Windows you can simply type 
        <span class="code">java -jar target/shamirs-demo-1.0.0-beta.jar</span> to invoke the demo.
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">$ java -Djava.security.egd=file:/dev/urandom -jar target/shamirs-demo-1.0.0-beta.jar
...
+---------------+
| Shamir's Demo |
+---------------+

Current time: 2020-05-22T14:26:10.667463
   Workspace: 2020-05-22

2020-05-22-> Main menu

       (s)plit password       (m)erge password       (o)pen workspace
      (c)reate keystore        (lo)ad keystore       (li)st workspace
                 (e)xit

2020-05-22-></p>
      </div>
      <p class="section">
        On Linux the explicit handover of the system property <span class="code">java.security.egd=file:/dev/urandom</span> is required otherwise the program would stall
        when generating random passwords. See <a href="https://www.2uo.de/myths-about-urandom/">Myths about /dev/urandom</a> for a discussion about the confusion
        regarding the special device files which serve as (pseudo) random generators on Linux systems.
        The string <span class="code">2020-05-22</span> left from the arrow denotes the current workspace. You automatically get a new one on every day you are using
        the app. The provided commands are invoked by their given shortcuts. Since this newly created workspace is empty we begin with splitting
        a password:
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> s
2020-05-22-> split password
2020-05-22-> Password ([A-Za-z0-9-]{8,45}): mdCArzFxaOrYtco5XNfLne39R 
2020-05-22-> Number of shares ([0-9]+): 12
2020-05-22-> Threshold ([0-9]+): 4
2020-05-22-> Name of partition ([A-Za-z]{1,10}): demo
2020-05-22-> Number of slices ([0-9]+): 7
2020-05-22-> Size[i=0, sum=0] ([0-9]+): 4
2020-05-22-> Size[i=1, sum=4] ([0-9]+): 2
2020-05-22-> Size[i=2, sum=6] ([0-9]+): 2
2020-05-22-> Size[i=3, sum=8] ([0-9]+): 1
2020-05-22-> Size[i=4, sum=9] ([0-9]+): 1
2020-05-22-> Size[i=5, sum=10] ([0-9]+): 1
2020-05-22-> Size[i=6, sum=11] ([0-9]+): 1</p>
      </div>
      <p class="section">
        The app will make a password proposal. Every user provided input will be matched against the regular expression 
        given in the brackets. In our example we instructed to generate 12 shares whereas 4 of them are needed to recover the original password. The shares
        are grouped within a partition named <span class="code">demo</span>. The 12 shares were divided into 7 slices. The first slice had been given 4
        shares. The next two slices have both received 2 shares and the remaining slices had been in each case given 1 share. Open another console
        and review the content of the your workspace directory (workspace/yyyy-MM-dd):
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">$ ls workspace/2020-05-22
demo-0.json  demo-1.json  demo-2.json  demo-3.json  demo-4.json  demo-5.json  demo-6.json  demo.json</p>
      </div>
      <p class="section">
        The file <span class="code">demo.json</span> contains all of the generated shares, <span class="code">demo-0.json</span> four of them, 
        <span class="code">demo-1.json</span> two and so on. 
        The idea is that we have seven participants in our example. Each of them will be given one slice. This means the participant owning the slice 
        <span class="code">demo-0.json</span> is able to recover the password by herself whereas the owner of <span class="code">demo-1.json</span> must team up with 
        the owner of <span class="code">demo-2.json</span> or with two of the owners of the remaining slices and so on. Now switch back to the demo app and invoke
        <span class="code">(li)st workspace</span>:
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> li
2020-05-22-> list workspace
2020-05-22-> Partitions: [demo]
2020-05-22-> Slices(demo): [demo-0.json, demo-1.json, demo-2.json, demo-3.json, demo-4.json, demo-5.json, demo-6.json]
2020-05-22-> Keystores: []</p>
      </div>
      <p class="section">
        We have already seen that. Now lets recover the original password by combining the slices <span class="code">demo-1.json</span>,
        <span class="code">demo-3.json</span> and <span class="code">demo-6.json</span>:
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> m
2020-05-22-> merge password
2020-05-22-> Slices (([A-Za-z]{1,10}-[0-9]+\.json(,( )*)?)+([A-Za-z]{1,10}-[0-9]+\.json)?): demo-1.json,demo-3.json,demo-6.json
2020-05-22-> password = mdCArzFxaOrYtco5XNfLne39R</p>
      </div>
      <p class="section">
        As expected. Merging works by providing a list of <a href="https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/nio/file/Path.html">Path</a>s 
        to the different slices and then applying Newtons Interpolation. That means the slices
        need not necessarily be located together in one directory as in our demo. In fact they could be distributed over the whole filesystem and could be
        located even on remote devices. Think of plugged-in USB memory sticks or network filesystems. Future versions might interpret the Paths as 
        <a href="https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/net/URI.html">URI</a>s and could fetch the slices over the network if required. <br/>
      </p>
      <p class="section">
        Now, let's create a keystore:
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> Main menu

       (s)plit password       (m)erge password       (o)pen workspace
      (c)reate keystore        (lo)ad keystore       (li)st workspace
                 (e)xit

2020-05-22-> c
2020-05-22-> create keystore
2020-05-22-> Keystore name ([A-Za-z-]{1,20}): my-keys
2020-05-22-> Slices (([A-Za-z]{1,10}-[0-9]+\.json(,( )*)?)+([A-Za-z]{1,10}-[0-9]+\.json)?): demo-3.json, demo-4.json, demo-5.json, demo-6.json

+---------------+
| Shamir's Demo |
+---------------+

Current time: 2020-05-23T14:54:04.018555
   Workspace: 2020-05-22

2020-05-22-> KeyStore menu [my-keys]

         (l)ist entries          (p)rivate key           (s)ecret key
          (c)ertificate            (m)ain menu

2020-05-22-></p>
      </div>
      <p class="section">
        We used four of the slices containing a single share to produce the credentials for the keystore. The demo app switched to a submenu regarding
        keystore functionality. At present the keystore is empty. A Java PKCS12 keystore can contain three different types of entries:
        <a href="https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/security/KeyStore.PrivateKeyEntry.html">Private Key</a>, 
        <a href="https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/security/KeyStore.SecretKeyEntry.html">Secret Key</a> and 
        <a href="https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/security/KeyStore.TrustedCertificateEntry.html">Certificate</a> entries.
        Private and Secret Keys need protection whereas certificates need not since latter are public. Hence we will create a Private Key. A Private Key
        is always accompanied with a certifcate that attests the associated Public Key. From the start these certificates are self-signed but could
        be the result from a PKCS10 certificate request too.
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> p
2020-05-22-> private key
2020-05-22-> Keygenerator algorithm (DSA|RSA|EC): EC
2020-05-22-> Validity ([0-9]+): 100
2020-05-22-> Common Name ([A-Za-z- ]{5,30}): Donald Duck
2020-05-22-> Locality ([A-Za-z- ]{5,30}): Entenhausen
2020-05-22-> State ([A-Za-z- ]{5,30}): Bayern
2020-05-22-> Country ([A-Za-z- ]{5,30}): Deutschland
2020-05-22-> Alias ([a-z0-9-]{5,25}): donalds-private-ec-key</p>
      </div>
      <p class="section">
        We specified Elliptic Curve (EC) as <a href="https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/security/KeyPairGenerator.html">KeyPairGenerator</a> 
        algorithm and a validity of 100 days for the accompanying self-signed certificate. The remaining parameter constitute the so called
        <a href="https://ldapwiki.com/wiki/Distinguished%20Names">Distinguished Name</a>.
      </p>
      <p class="section">
        Now, list the entries so far:
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> l
2020-05-22-> list entries
2020-05-22-> donalds-private-ec-key: friendlyName=donalds-private-ec-key, localId=54:69:6d:65:20:31:35:39:30:32:33:39:36:30:30:39:30:32, algorithm=EC, keytype=Private Key</p>
      </div>
      <p class="section">
        Go back to main menu:
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> m
2020-05-22-> main menu

+---------------+
| Shamir's Demo |
+---------------+

Current time: 2020-05-23T15:42:23.311563
   Workspace: 2020-05-22

2020-05-22-> Main menu

       (s)plit password       (m)erge password       (o)pen workspace
      (c)reate keystore        (lo)ad keystore       (li)st workspace
                 (e)xit

2020-05-22-></p>
      </div>
      <p class="section">
        Now, list the workspace again:
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> li
2020-05-22-> list workspace
2020-05-22-> Partitions: [demo]
2020-05-22-> Slices(demo): [demo-0.json, demo-1.json, demo-2.json, demo-3.json, demo-4.json, demo-5.json, demo-6.json]
2020-05-22-> Keystores: [my-keys]</p>
      </div>
      <p class="section">
        Again, merge some of the slices to recover the password of the keystore:
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> m
2020-05-22-> merge password
2020-05-22-> Slices (([A-Za-z]{1,10}-[0-9]+\.json(,( )*)?)+([A-Za-z]{1,10}-[0-9]+\.json)?): demo-1.json, demo-2.json
2020-05-22-> password = mdCArzFxaOrYtco5XNfLne39R</p>
      </div>
      <p class="section">
        Switch to a separate console since we want to investigate the keystore with 
        <a href="https://docs.oracle.com/en/java/javase/14/docs/specs/man/keytool.html">keytool</a>. Note that your own workspace is probably
        different.
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">$ cd workspace/2020-05-22  # workspace/yyyy-MM-dd
$ ls
demo-0.json  demo-1.json  demo-2.json  demo-3.json  demo-4.json  demo-5.json  demo-6.json  demo.json  my-keys.p12
$ keytool -list -keystore my-keys.p12 -storepass mdCArzFxaOrYtco5XNfLne39R -storetype pkcs12 -v
Keystore type: PKCS12
Keystore provider: SUN

Your keystore contains 1 entry

Alias name: donalds-private-ec-key
Creation date: 23.05.2020
Entry type: PrivateKeyEntry
Certificate chain length: 1
Certificate[1]:
Owner: C=Deutschland, ST=Bayern, L=Entenhausen, CN=Donald Duck
Issuer: C=Deutschland, ST=Bayern, L=Entenhausen, CN=Donald Duck
Serial number: 17241aa9c70
Valid from: Sat May 23 15:13:19 CEST 2020 until: Mon Aug 31 15:13:19 CEST 2020
Certificate fingerprints:
	 SHA1: FC:E0:1A:AA:E4:91:88:5C:FF:5F:43:66:FE:43:C9:6A:43:60:5C:48
	 SHA256: C1:6B:87:B6:9C:C9:6D:65:3D:5E:E8:BF:0B:9B:82:41:DF:D8:88:C9:DA:33:1E:62:79:AA:5D:41:A5:41:EE:FD
Signature algorithm name: SHA256withECDSA
Subject Public Key Algorithm: 521-bit EC (secp521r1) key
Version: 3


*******************************************
*******************************************</p>
      </div>
      <p class="section">
        Note that we used the recovered password in combination with keytool. This will be the end of our little tour. There are other
        options to consider and there are some rough egdes as well. For example <a href="https://cr.yp.to/chacha/chacha-20080128.pdf">ChaCha20</a> 
        secret keys don't work since the underlying keystore implementation of the JDK doesn't regocnize them.
      </p>
      <div class="code">
        <p class="code" style="white-space: pre">2020-05-22-> Main menu

       (s)plit password       (m)erge password       (o)pen workspace
      (c)reate keystore        (lo)ad keystore       (li)st workspace
                 (e)xit

2020-05-22-> e
2020-05-22-> exit</p>
      </div>
      <p class="section">
        <a href="#1">[ToC]</a>
      </p>
      <div id="imprint" style="text-align: center; border-top-style: solid; border-top-color: rgb(26,26,26); border-top-width: 1px; margin-top: 1rem">
        <img style="" src="./impressum.png" alt="Impressum" />
      </div>
    </div>
  </body>
</html>